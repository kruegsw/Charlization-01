<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../partials/head'); %>
</head>

<body class="container">

<header>
  <%- include('../partials/header'); %>
</header>

<main>
  <div id="player-list">

  </div>
  <div class="jumbotron">
    <h1><%= game.gameName %></h1>
  </div>
  <div>
    <div id="chat-log" style="border: 1px solid"></div>
    <label for="message-input">Message</label>
    <input type="text" id="message-input">
    <button id="send-button">Send</button>

  </div>
</main>

<footer>
  <%- include('../partials/footer'); %>
</footer>

<!-- socket io library for websocket connection to server back end -->
<script
  src="https://cdn.socket.io/4.6.0/socket.io.min.js"
  integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
  crossorigin="anonymous">
</script>

<!-- workaround to pass server side EJS variable to client side JS variable -->
<script>
  var clientSocketURL = '<%- socketURL %>' // test is now a valid js object
  var clientGameID = '<%- game._id %>'
  console.log(clientSocketURL)
</script>
<!-- end workaround -->

<script>
  const socket = io(`${clientSocketURL}`, {'transports': ['websocket', 'polling']}); // establish websocket connection
  // trasports options must be specified for mobile browser, see:
  // https://stackoverflow.com/questions/23946683/socket-io-bad-request-with-response-code0-messagetransport-unknown
  //console.log(socket)

  socket.on("connect", () => {
    // console.log(`Client ${socket.id} connected to the WebSocket`) // id randomly assigned to client
    
    socket.emit('join-game', room = clientGameID, roomClients => {
      //console.log("players are " + roomClients)
      ///////////////////////////////////////////////////// clean this up, move to separate event?
      updatePlayerList(roomClients)
      ///////////////////////////////////////////////////// clean this up, move to separate event?
      //console.log(playerArray)
    })

    socket.on("disconnect", room = clientGameID, roomClients => {
      //console.log(socket.id); // undefined
      ///////////////////////////////////////////////////// clean this up, move to separate event?
      updatePlayerList(roomClients)
      ///////////////////////////////////////////////////// clean this up, move to separate event?
    });

    socket.on('receive-message', (message, author) => {
      console.log(`received messaged from server: ${message}`)
      updateChatLog(message, author)
    })
  });
</script>
<script>

  const sendButton = document.getElementById("send-button")
  const messageInput = document.getElementById('message-input')
  const chatLog = document.getElementById('chat-log')
  const playerList = document.getElementById('player-list')

  sendButton.addEventListener('click', () => {
    const message = messageInput.value
    socket.emit('send-message', message, room = clientGameID)
    messageInput.value = ""
  })

  messageInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      const message = messageInput.value
      socket.emit('send-message', message, room = clientGameID)
      messageInput.value = ""
    }
  });

</script>
<script>
  function updateChatLog(message, author) {
    let div = document.createElement("div")
    div.textContent = `${author}:  ${message}`
    document.getElementById('chat-log').append(div)
  }

  function updatePlayerList(players) {
    playerList.textContent = `Currently in game:  ${players}`
  }
</script>
</body>
</html>